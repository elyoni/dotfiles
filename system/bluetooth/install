#!/usr/bin/env bash
#
# Origin manual https://gist.github.com/the-spyke/2de98b22ff4f978ebf0650c90e82027e?permalink_comment_id=3976215

function _install_wire_plumber()
{
    # .Install WirePlumber as the session manager:

    sudo apt install -y pipewire-media-session- wireplumber

    #    Notice '-' at the end of 'pipewire-media-session'. This is to remove it in the same command, because 'wireplumber' will be used instead.
    # .Start WirePlumber for your user:

    systemctl --user --now enable wireplumber.service
}

function _install_conf_alsa()
{
    # Install the ALSA plug-in:
    # Note: pipewire-audio-client-libraries may pull in pipewire-jack which can have version conflicts
    echo "Installing PipeWire ALSA client libraries..."
    
    # Check if already installed
    if dpkg -l | awk -v pkg="pipewire-audio-client-libraries" '$1=="ii" && $2==pkg {found=1; exit} END {exit !found}' >/dev/null 2>&1; then
        echo "pipewire-audio-client-libraries is already installed"
        return 0
    fi
    
    local install_output=""
    local install_success=false
    
    # Try normal installation first
    install_output=$(sudo apt install -y pipewire-audio-client-libraries 2>&1)
    local install_exit_code=$?
    
    if [ $install_exit_code -eq 0 ]; then
        install_success=true
    else
        # Check if the error is about pipewire-jack version conflict
        if echo "$install_output" | grep -q "pipewire-jack.*Depends.*but.*is to be installed"; then
            echo "Warning: pipewire-jack version conflict detected (this is usually safe to ignore)"
            echo "pipewire-jack requires exact versions that may conflict with Ubuntu's pipewire packages"
            echo "Attempting to install without pipewire-jack dependency..."
            
            # Try installing with --no-install-recommends and allow broken dependencies temporarily
            # First, try to install without recommended packages
            if sudo apt install -y --no-install-recommends pipewire-audio-client-libraries 2>&1; then
                install_success=true
            else
                # If that fails, try installing the package but allowing broken pipewire-jack
                echo "Attempting alternative installation method..."
                if sudo apt install -y --fix-broken pipewire-audio-client-libraries 2>&1 | grep -v "pipewire-jack"; then
                    # Verify it was actually installed
                    if dpkg -l | awk -v pkg="pipewire-audio-client-libraries" '$1=="ii" && $2==pkg {found=1; exit} END {exit !found}' >/dev/null 2>&1; then
                        install_success=true
                    fi
                fi
            fi
            
            if [ "$install_success" != true ]; then
                echo "Note: Could not install pipewire-audio-client-libraries due to dependency conflicts"
                echo "This is usually safe - basic PipeWire functionality should still work"
                echo "The installed pipewire version ($(dpkg -l pipewire 2>/dev/null | awk 'NR>5 && $1=="ii" {print $3; exit}')) is compatible"
            fi
        else
            # Some other error occurred
            echo "Warning: Installation had issues:"
            echo "$install_output" | grep -E "Error|error|Unable|E:" | head -3 || true
            echo "Continuing anyway - PipeWire may already be functional"
        fi
    fi
    
    # Verify installation
    if dpkg -l | awk -v pkg="pipewire-audio-client-libraries" '$1=="ii" && $2==pkg {found=1; exit} END {exit !found}' >/dev/null 2>&1; then
        echo "PipeWire ALSA client libraries installed successfully"
        return 0
    elif [ "$install_success" = true ]; then
        echo "PipeWire ALSA client libraries installation completed"
        return 0
    else
        echo "Note: pipewire-audio-client-libraries was not installed, but continuing..."
        return 0  # Don't fail - PipeWire can work without this package
    fi

    # And copy the config file from PipeWire docs (provided by the plug-in) into the ALSA configuration directory:
    # Check if the source file exists first
    local source_file="/usr/share/doc/pipewire/examples/alsa.conf.d/99-pipewire-default.conf"
    local dest_dir="/etc/alsa/conf.d"
    
    if [ -f "$source_file" ]; then
        # Ensure destination directory exists
        sudo mkdir -p "$dest_dir"
        sudo cp "$source_file" "$dest_dir/"
        echo "ALSA configuration file copied successfully"
    else
        echo "Warning: PipeWire ALSA config file not found at $source_file"
        echo "This may be normal if PipeWire is not fully installed or uses a different path"
        # Try alternative locations
        local alt_locations=(
            "/usr/share/pipewire/alsa.conf.d/99-pipewire-default.conf"
            "/usr/share/doc/pipewire-alsa/examples/alsa.conf.d/99-pipewire-default.conf"
        )
        for alt_file in "${alt_locations[@]}"; do
            if [ -f "$alt_file" ]; then
                sudo mkdir -p "$dest_dir"
                sudo cp "$alt_file" "$dest_dir/"
                echo "ALSA configuration file copied from alternative location: $alt_file"
                return 0
            fi
        done
        echo "Could not find PipeWire ALSA config file. Continuing without it..."
    fi

    # Check if you have other (like Pulse) configs in the /etc/alsa/conf.d/ installed by something else. You might want to remove them.
}


function _install_bluetooth()
{
    # Install the codecs and remove Bluetooth from PulseAudio, so it would be handled directly by PipeWire:
    # Note: We install packages individually to handle potential conflicts better
    
    echo "Installing Bluetooth codecs and PipeWire support..."
    
    # Install codecs first, but skip pipewire-jack if it causes version conflicts
    # pipewire-jack may be pulled in as a dependency but conflicts with Ubuntu's pipewire version
    local install_output=""
    install_output=$(sudo apt install -y libldacbt-abr2 libldacbt-enc2 libspa-0.2-bluetooth 2>&1) || true
    
    # Check if the error is about pipewire-jack version conflict
    if echo "$install_output" | grep -q "pipewire-jack.*Depends.*but.*is to be installed"; then
        echo "Warning: pipewire-jack version conflict detected (this is usually safe to ignore)"
        echo "Attempting to install without pipewire-jack..."
        
        # Try installing without pipewire-jack by explicitly excluding it
        sudo apt install -y libldacbt-abr2 libldacbt-enc2 libspa-0.2-bluetooth --no-install-recommends 2>&1 | grep -v "already the newest\|is already\|pipewire-jack" || true
        
        # If that still fails, try installing each package individually
        sudo apt install -y libldacbt-abr2 2>&1 | grep -v "already the newest\|is already" || true
        sudo apt install -y libldacbt-enc2 2>&1 | grep -v "already the newest\|is already" || true
        
        # For libspa-0.2-bluetooth, try to install it but allow the pipewire-jack conflict
        if ! sudo apt install -y libspa-0.2-bluetooth 2>&1 | grep -v "already the newest\|is already\|pipewire-jack"; then
            echo "Note: libspa-0.2-bluetooth installation had issues due to pipewire-jack conflict"
            echo "This is usually safe - Bluetooth will work with the installed pipewire version"
        fi
    else
        # No conflict, normal installation
        echo "$install_output" | grep -v "already the newest\|is already" || true
    fi
    
    # Remove pulseaudio bluetooth module (the '-' suffix removes it)
    # Handle this more carefully to avoid errors
    if dpkg -l | grep -q "^ii.*pulseaudio-module-bluetooth"; then
        echo "Removing pulseaudio-module-bluetooth..."
        sudo apt remove -y pulseaudio-module-bluetooth 2>&1 | grep -v "is not installed" || true
    fi

    # The supported codecs are SBC and LDAC.
    # Unfortunately, aptX and AAC are not supported because of patents and other technical reasons. aptX is available starting from 22.10 via libfreeaptx0 installed by default there (22.10 uses PipeWire by default as well). If you really need these codecs in 22.04 you may use this PPA from @aglasgall which is based on universe, but rebuilds pipewire with additional packages for aptX and AAC from multiverse. Read the discussion here.
}

function install()
{
    # Install components with error handling
    if ! _install_wire_plumber; then
        echo "Warning: WirePlumber installation had issues, continuing..."
    fi
    
    if ! _install_conf_alsa; then
        echo "Warning: ALSA configuration had issues, continuing..."
    fi
    
    if ! _install_bluetooth; then
        echo "Warning: Bluetooth codec installation had issues"
        echo "Note: If you see pipewire-jack dependency errors, this is usually safe to ignore"
        echo "The system will use the installed pipewire version"
    fi
    
    # Try to fix any broken dependencies
    echo "Checking for broken dependencies..."
    sudo apt-get install -f -y 2>&1 | grep -v "0 upgraded\|0 newly installed" || true
}

function verify()
{
    :
}

function help # Show a list of functions
{
    awk '/^function / && ! /^function _/' "$0"
}

if [ $# -eq 0 ]; then
    help
else
    "$@"
fi
