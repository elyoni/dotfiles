#!/usr/bin/env bash

DIR=$(dirname "${BASH_SOURCE[0]}")
DIR=$(cd -P "${DIR}" && pwd)

source "${DIR}"/../../../utils/package/apt
source "${DIR}"/../../../utils/package/github
source "${DIR}"/../../../utils/smart_link


function _install_ghostty() # Install Ghostty terminal emulator via snap
{
    echo "Installing Ghostty..."

    # Check if already installed
    if command -v ghostty &> /dev/null; then
        echo "Ghostty is already installed"
        return 0
    fi

    # Install snap if not available
    if ! command -v snap &> /dev/null; then
        echo "Installing snapd..."
        fast_apt_install "snapd"
    fi

    # Install Ghostty via snap
    echo "Installing Ghostty from snap..."
    sudo snap install ghostty --classic
    
    if [ $? -eq 0 ]; then
        echo "Ghostty installed successfully"
        return 0
    else
        echo "Failed to install Ghostty"
        return 1
    fi
}

function verify() # Verify the installation
{
    if command -v ghostty &> /dev/null; then
        echo "✓ Ghostty is installed: $(ghostty --version)"

        # Check if config is linked
        if [ -L "$HOME/.config/ghostty/config" ]; then
            echo "✓ Config file is properly linked"
        else
            echo "✗ Config file is not linked"
            return 1
        fi

        # Check if theme is linked
        if [ -L "$HOME/.config/ghostty/themes/NvimDark" ]; then
            echo "✓ NvimDark theme is properly linked"
        else
            echo "✗ NvimDark theme is not linked"
            return 1
        fi

        return 0
    else
        echo "✗ Ghostty is not installed"
        return 1
    fi
}


function install()
{
    _install_ghostty

    # Create config directory if it doesn't exist
    mkdir -p "$HOME/.config/ghostty"
    mkdir -p "$HOME/.config/ghostty/themes"

    # Link config file
    smart_link "${DIR}/config" "$HOME/.config/ghostty/config"
    
    # Link theme files
    smart_link "${DIR}/themes/NvimDark" "$HOME/.config/ghostty/themes/NvimDark"
}

function help # Show a list of functions
{
    awk '/^function / && ! /^function _/' "$0"
}

if [ $# -eq 0 ]; then
    help
else
    "$@"
fi
