#!/usr/bin/env bash

DIR=$(dirname "${BASH_SOURCE[0]}")
DIR=$(cd -P "${DIR}" && pwd)

source "${DIR}"/../../utils/package/github

function link_files()
{
    echo ======= Link Files =======
    echo ln -sf "${DIR}"/gitconfig "${HOME}"/.gitconfig
    ln -sf "${DIR}"/gitconfig "${HOME}"/.gitconfig
    echo =======   End   =======
}

function install_meld()
{
    sudo apt-get install -y meld
}

function _install_meld_git()
{
    VERSION="meld-3.22.0"
    echo ======= install meld version $VERSION =======
    sudo apt-get install -y \
        intltool \
        itstool \
        gir1.2-gtksource-3.0 \
        libxml2-utils \
        libgirepository1.0-dev


    LIB_VERSION=$(echo $VERSION | sed 's/meld-\([0-9]\+.[0-9]\+\).*/\1/')
    mkdir -p "$HOME"/Downloads/apps/meld
    wget -P "$HOME"/Downloads/apps/meld https://download.gnome.org/sources/meld/"$LIB_VERSION"/${VERSION}.tar.xz
    tar -C "$HOME"/Downloads/apps/meld -xvf "$HOME"/Downloads/apps/meld/${VERSION}.tar.xz

    pushd "$HOME"/Downloads/apps/meld/${VERSION}/ || exit  # Must install from the library
    sudo ./setup.py install --prefix=/usr
    popd - || exit
    echo ======= End  =======
}

function install_cdiff()
{
    pipx install cdiff
}

function install_glab()
{
    echo ======= Install GitLab CLI (glab) =======
    if ! command -v glab >/dev/null 2>&1; then
        curl -fsSL https://gitlab.com/gitlab-org/cli/-/raw/main/scripts/install.sh | sudo bash
    else
        echo "glab is already installed"
    fi
    echo ======= End =======
}

function setup_glab_completion()
{
    echo ======= Setup glab completion =======
    local completion_dir="$HOME/.local/share/bash-completion/completions"
    mkdir -p "$completion_dir"

    if command -v glab >/dev/null 2>&1; then
        glab completion -s bash > "$completion_dir/glab"
        echo "glab bash completion installed to $completion_dir/glab"
    else
        echo "glab not found, skipping completion setup"
    fi

    # Install git mr completion
    if [[ -f ~/.work_dotfiles/git/mr_completion.bash ]]; then
        cp ~/.work_dotfiles/git/mr_completion.bash "$completion_dir/git-mr"
        echo "git mr bash completion installed to $completion_dir/git-mr"
    fi

    echo ======= End =======
}

function install()
{
    link_files
    install_cdiff
    install_glab
    setup_glab_completion
    [ -n "${DISPLAY}" ] && install_meld
}

function verify() # Verify the installation
{
    if [ ! -f "$HOME"/.gitconfig ]; then
        return 1
    fi
}

function help # Show a list of functions
{
    awk '/^function / && ! /^function _/' "$0"
}

if [ $# -eq 0 ]; then
    help
else
    "$@"
fi
