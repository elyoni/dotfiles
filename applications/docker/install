#!/usr/bin/env bash
DIR=$(dirname "${BASH_SOURCE[0]}")
DIR=$(cd -P "$DIR" && pwd)

function __verify_docker_permissions()
{
    # NOTE: utile function, not for the verification stage
    # If the permissions is correct I can remove the `sudo` from the verify commands
    # return 1 if the permission is only for sudo
    # return 0 if the permission are for the users
    :
}

function __uninstall_docker()
{
    # uninstall when using get-docker.sh install
    sudo dpkg -P \
        docker-ce \
        docker-ce-cli \
        docker-compose-plugin \
        docker-scan-plugin
    sudo apt-get install -f
}

function _install_buildx()
{
    echo "Installing Docker buildx multi-arch builder..."
    
    # Use sudo for docker commands since user may not have logged out yet
    # Check if buildx already exists
    if sudo docker buildx ls 2>/dev/null | grep -q "multi-arch-buildx"; then
        echo "Removing existing multi-arch-buildx builder..."
        sudo docker buildx rm multi-arch-buildx 2>/dev/null || true
    fi

    # Create new buildx builder
    if sudo docker buildx create --name multi-arch-buildx \
        --platform "linux/arm64,linux/amd64,linux/arm/v7,linux/amd64,linux/amd64/v2,linux/amd64/v3,linux/amd64/v4,linux/386" \
        --driver "docker-container" --use >/dev/null 2>&1; then
        echo "Docker buildx multi-arch builder created successfully"
    else
        echo "WARNING: Failed to create buildx builder"
        echo "You may need to logout/login first, then run: docker buildx create --name multi-arch-buildx --use"
        return 1
    fi
}


# Tested on Ubuntu and Debian
function _install_docker_engine()
{
    local dist
    dist=$(lsb_release --short --id  2>/dev/null | awk '{print tolower($0)}')

    echo ====== START: Install docker engine =====

    echo "== Install packages =="
    echo "== Install docker with get-docker.sh =="

    # Add Docker's official GPG key:
    sudo apt-get update
    sudo apt-get install ca-certificates curl
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL "https://download.docker.com/linux/${dist}/gpg" -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc

    # Add the repository to Apt sources:
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/${dist} \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    sudo apt-get update
    sudo apt-get install -y \
        docker-ce \
        docker-ce-cli \
        containerd.io \
        docker-buildx-plugin \
        docker-compose-plugin

    echo ====== END: Install docker engine =====
}

function _fix_docker_permissions()
{
    # Original tutorial: https://docs.docker.com/engine/install/linux-postinstall/
    echo ====== START: Fix docker permissions =====
    echo "== Create the docker group =="
    if ! getent group docker >/dev/null 2>&1; then
        sudo groupadd docker
    else
        echo "Docker group already exists"
    fi

    echo "== Add your user to the docker group =="
    if ! groups "$USER" | grep -q "\bdocker\b"; then
        sudo usermod -aG docker "$USER"
        echo "User $USER added to docker group"
        echo "NOTE: You need to logout and login again (or run 'newgrp docker') for permissions to take effect"
        echo "The script will continue, but docker commands without sudo may fail until you logout/login"
    else
        echo "User $USER is already in docker group"
    fi

    # Don't use newgrp here - it creates a sub-shell that breaks script execution
    # Instead, inform the user they need to logout/login
    echo "====== END: Fix docker permissions ====="
}

function _verify_fix_docker_permissions()
{
    # Run docker command without sudo
    # Note: This will only work if user has logged out and back in after being added to docker group
    local test_image="hello-world"
    
    # Check if user is in docker group
    if ! groups "$USER" | grep -q "\bdocker\b"; then
        echo "WARNING: User $USER is not in docker group yet"
        echo "This verification will be skipped - user needs to logout/login after group addition"
        return 0  # Don't fail, just warn
    fi
    
    # Try to run docker without sudo
    if ! docker run --rm "${test_image}" >/dev/null 2>&1; then
        echo "WARNING: Docker permission fix verification failed"
        echo "This is normal if you haven't logged out and back in yet"
        echo "After logout/login, run: docker run --rm hello-world"
        return 0  # Don't fail the installation
    else
        echo "INSTALL_SUCCESS: Docker permission fix verified successfully"
        return 0
    fi
}

function _verify_docker_engine()
{
    local test_image="hello-world"
    echo "Verifying Docker engine installation..."
    
    # Check if Docker daemon is running
    if ! sudo docker info >/dev/null 2>&1; then
        echo "WARNING: Docker daemon is not running"
        echo "Start it with: sudo systemctl start docker"
        echo "Enable it with: sudo systemctl enable docker"
        return 1
    fi
    
    # Try to run a test container
    if ! sudo docker run --rm "${test_image}" >/dev/null 2>&1; then
        echo "INSTALL_FAILED: Docker engine verification failed"
        echo "Docker daemon is running but cannot run containers"
        return 1
    else
        echo "INSTALL_SUCCESS: Docker engine is working correctly"
        return 0
    fi
}

function _verify_buildx()
{
    echo "NOTE: WIP verify buildx installation not support yet"
    echo "Continue"
}

function install()
{
    _install_docker_engine
    _fix_docker_permissions
    _install_buildx
}

function verify()
{
    local all_good=true
    
    # Verify Docker engine (critical)
    if ! _verify_docker_engine; then
        all_good=false
    fi
    
    # Verify buildx (optional, just logs a note)
    _verify_buildx
    
    # Verify permissions (may fail if user hasn't logged out, that's OK)
    _verify_fix_docker_permissions
    
    if [ "$all_good" = true ]; then
        return 0
    else
        return 1
    fi
}

function help() # Show a list of functions
{
    awk '/^function / && ! /^function _/' "$0"
}

if [ $# -eq 0 ]; then
    help
else
    "$@"
fi
